pipeline {
  agent any

 tools  {
   maven 'M2_HOME'
   terraform 'terraform-0.11.14'
        }
 environment {
        AWS_ACCESS_KEY_ID = '${Access_Key}'
        AWS_SECRET_KEY = '${Secret_Key}'
        }

 stages {
   stage ('checkout') {
     steps  {
       echo  'Checkout the source code from github'
       git 'https://github.com/fhk2022/BankingProject2.git'
            }
        }
   stage('Package the Application') {
     steps {
       echo "packaging the Application"
       sh 'mvn clean package'
          }
  }

  stage('Publish the Reports using HTML') {
    steps {
    publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: '/var/lib/jenkins/workspace/Banking-Project/target/surefire-reports', reportFiles: 'index.html', reportName: 'HTML Report', reportTitles: '', useWrapperFileDirectly: true])
          }
}

  stage('Docker Image Creation'){
    steps {
    sh 'docker build -t  faisalhkdocker/bankingproject:latest  .'
          }            
}

  stage('Push Image to DockerHub'){
    steps {
       withCredentials([usernamePassword(credentialsId: 'Docker-hub-faisalhkdocker', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
       sh "docker login -u ${env.dockerHubUser} -p ${env.dockerHubPassword}"
       sh 'docker push  faisalhkdocker/bankingproject:latest'

                    }
           }
            }
  stage('Terraform init') {
    steps {
      sh   'terraform init'
          }
}
  stage('Terraform fmt'){
    steps {
      sh 'terraform fmt'
          }

     } 
  stage('Terraform validate'){
    steps {
      sh 'terraform validate'

          }

     }
  stage('Terraform plan'){
    steps {
    withCredentials([sshUserPrivateKey(credentialsId: 'my-ssh-key', keyFileVariable: 'SSH_KEY')]) {
  sh 'eval `ssh-agent -s` && ssh-add $SSH_KEY'
  sh 'terraform plan'
         }
}
}
  stage('Terraform apply'){
    steps {
      sh 'terraform apply -auto-approve'
          sleep 10
          } 
	   }
  stage ('Configure Test-server with Terraform, Ansible and then Deploying'){
            steps {
                dir('test-server'){
                sh 'sudo chmod 600 dec3batch.pem'
                sh 'terraform init'
                sh 'terraform validate'
                sh 'terraform apply --auto-approve'
                }
            }
        } 

}
}


